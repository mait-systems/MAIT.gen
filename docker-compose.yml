version: "3.9"

services:
  influxdb:
    image: influxdb:2.8.0
    container_name: influxdb
    ports:
      - "8086:8086"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    restart: always
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD:-admin123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-mlr}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-stbd_gen}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN:-your-influxdb-token-here}
      - DOCKER_INFLUXDB_INIT_RETENTION=0

  backend:
    build:
      context: .
      dockerfile: mait-backend/Dockerfile
    command: uvicorn main:app --host 0.0.0.0 --port 8001
    ports:
      - "8001:8001"
    volumes:
      - shared_logs:/app/logs
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-your-influxdb-token-here}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-mlr}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-stbd_gen}
    depends_on:
      - influxdb
    restart: unless-stopped

  frontend:
    build:
      context: ./mait-front
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}
    depends_on:
      - backend
    restart: unless-stopped

  modbus-poller:
    build:
      context: .
      dockerfile: Dockerfile.poller
    volumes:
      - ./generator_config.yaml:/app/generator_config.yaml
      - shared_logs:/app/logs
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-your-influxdb-token-here}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-mlr}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-stbd_gen}
    depends_on:
      - influxdb
    restart: unless-stopped

  powertrain-agent:
    build:
      context: .
      dockerfile: Dockerfile.powertrain
    volumes:
      - ./generator_config_gateway.yaml:/app/generator_config_gateway.yaml
      - ./generator_config.yaml:/app/generator_config.yaml
      - shared_logs:/app/logs
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-your-influxdb-token-here}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-mlr}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-stbd_gen}
      - POWERTRAIN_INTERVAL=${POWERTRAIN_INTERVAL:-5}
      - POWERTRAIN_BOOTSTRAP=${POWERTRAIN_BOOTSTRAP:-false}
      - POWERTRAIN_AI_ENABLED=${POWERTRAIN_AI_ENABLED:-false}
      - POWERTRAIN_IDLE_TIMEOUT=${POWERTRAIN_IDLE_TIMEOUT:-5}
      - GATEWAY_URL=${GATEWAY_URL}
      - GATEWAY_API_KEY=${GATEWAY_API_KEY}
      - BACKEND_URL=http://backend:8001
    depends_on:
      - influxdb
      - modbus-poller
    restart: unless-stopped

volumes:
  influxdb_data:
  influxdb_config:
  shared_logs:
